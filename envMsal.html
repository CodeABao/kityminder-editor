<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://libs.baidu.com/jquery/2.0.0/jquery.min.js"></script>
    <script type="text/javascript" src="https://alcdn.msauth.net/browser/2.14.2/js/msal-browser.min.js">
    </script>
</head>

<body>
    <script>
        function toQueryString(queryParams) {
            let encodedQueryParams = [];
            for (let key in queryParams) {
                encodedQueryParams.push(
                    key + "=" + encodeURIComponent(queryParams[key])
                );
            }
            return encodedQueryParams.join("&");
        }
        const pca = new msal.PublicClientApplication({
            auth: {
                clientId: "c9b5f67d-5500-4e6e-9529-6c5344abe2e0",
                authority: "https://login.microsoftonline.com/5c7d0b28-bdf8-410c-aa93-4df372b16203",
                redirectUri: "http://localhost:3000/envMsal.html",
            },
            cache: {
                cacheLocation: "localStorage"
            },
            system: {
                loggerOptions: {
                    loggerCallback(loglevel, message, containsPii) {
                        console.log(message);
                    },
                    piiLoggingEnabled: false,
                    logLevel: msal.LogLevel.Verbose,
                }
            }
        });

        var accounts = pca.getAllAccounts();

        //var fileUrl = toQueryString("fileUrl");
        var fileUrl = "https://lenovobeijing-my.sharepoint.com/:t:/r/personal/libx6_lenovo_com/Documents/Sync/Work/20170116.txt";
        getFile(fileUrl);
        debugger;
        function getToken(hostUrl, callback) {
            accounts = pca.getAllAccounts();

            var scope = hostUrl + "/.default";

            pca.acquireTokenSilent({
                scopes: [scope],
                account: accounts[0]
            }).then((response) => {
                callback(response);
            })
        }

        function getFile(fileUrl) {
            var urls = fileUrl.split("/");
            var hostUrl = "https://" + urls[2];
            var fileRelativeUrl = fileUrl.replace(hostUrl, "");
            var siteUrl;
            if (fileUrl.indexOf(":t:") > -1) {
                siteUrl = hostUrl + "/" + urls[5] + "/" + urls[6];
                fileRelativeUrl = fileRelativeUrl.replace("/:t:/r", "");
            } else {
                siteUrl = hostUrl + "/" + urls[3] + "/" + urls[4];
            }

            login(hostUrl, function (response) {
                var reqUrl = siteUrl + "/_api/web/GetFileByServerRelativeUrl('" + fileRelativeUrl + "')/$value";

                $.ajax({
                    type: "GET",
                    url: reqUrl,
                    headers: {
                        "Authorization": "Bearer " + response.accessToken,
                        "accept": "application/json;odata=verbose"
                    }
                }).done(function (res) {




                    debugger;
                }).fail(function () {
                    console.log("Fetching list from SharePoint failed.");
                });

            });
        }

        function login(hostUrl, callback) {
            if (accounts.length == 0) {
                pca.loginPopup().then((response) => {
                    console.log(`Hello ${response.account.username}!`);
                    getToken(hostUrl, callback);
                });
            } else {
                getToken(hostUrl, callback);
            }
        }

    </script>
</body>

</html>